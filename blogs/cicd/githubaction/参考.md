# å‰è¨€

è¿™æ˜¯ä¸€ç¯‡å±äºé¢å‘**å‰ç«¯**çš„å…³äº`CICD`å’Œ`Github Action`çš„å…¥é—¨æ–‡ç« ï¼Œå…¶æ—¨åœ¨ï¼š

1.  å…¥é—¨æŒæ¡`Github Action`çš„ç”¨æ³•
2.  å­¦ä¹ `CI`å’Œ`CD`çš„å«ä¹‰åŠå…¶å®ç°ç»†èŠ‚
3.  åŸºäº`Github Action`å±•ç¤ºå¦‚ä½•ç»™è‡ªå·±æ‰‹ä¸Šçš„é¡¹ç›®æ·»åŠ `CICD`çš„æµç¨‹
4.  åŸºäº`CICD`æµç¨‹å»æ·»åŠ å…¶ä»–å»¶ä¼¸æœºåˆ¶ï¼Œå¦‚å›æ»šã€ç«¯å¯¹ç«¯æµ‹è¯•ç­‰

äº‹ä¸å®œè¿Ÿï¼Œç›´æ¥å¼€å§‹æœ¬æ–‡çš„å†…å®¹å§ã€‚

# ä¸ºä»€ä¹ˆè¦é€‰æ‹©`Github Action`

æœ¬æ–‡é€‰æ‹©`Github Action`ä¸ä»£è¡¨ä»–æ˜¯æœ€å¥½é€‰æ‹©ï¼Œä½†åœ¨æˆ‘ç”¨è¿‡çš„**CICD å·¥å…·**ä¸­ï¼Œä»–å¯¹**å¼€æºé¡¹ç›®**çš„æ”¯æŒæ˜¯æœ€å‹å¥½çš„(ä¸è¿‡è¿™ä¸ªé¡¹ç›®å¾—æ”¾åœ¨`Github`ï¼Œå¦‚æœæ˜¯æ”¾åœ¨`Gitee`å°±ç”¨ä¸åˆ°äº†)ã€‚

> å…¬å…±ä»“åº“å’Œè‡ªæ‰˜ç®¡è¿è¡Œå™¨å…è´¹ä½¿ç”¨ `GitHub Actions`ã€‚ å¯¹äºç§æœ‰ä»“åº“ï¼Œæ¯ä¸ª GitHub å¸æˆ·å¯è·å¾—ä¸€å®šæ•°é‡çš„å…è´¹è®°å½•å’Œå­˜å‚¨ï¼Œå…·ä½“å–å†³äºå¸æˆ·æ‰€ä½¿ç”¨çš„äº§å“ã€‚ è¶…å‡ºåŒ…å«é‡‘é¢çš„ä»»ä½•ä½¿ç”¨é‡éƒ½ç”±æ”¯å‡ºé™åˆ¶æ§åˆ¶ã€‚

`Github Action`åœ¨**å¼€æºé¡¹ç›®**æ˜¯å…è´¹ä½¿ç”¨çš„ï¼Œè€Œåœ¨**ç§æœ‰é¡¹ç›®**æ–¹é¢çš„è®¡è´¹ä¼šæ ¹æ®ä½ è´­ä¹°çš„æœåŠ¡è€Œä¸åŒï¼Œè¯¦ç»†å¯çœ‹[å…³äº GitHub Actions çš„è®¡è´¹](https://docs.github.com/cn/billing/managing-billing-for-github-actions/about-billing-for-github-actions "https://docs.github.com/cn/billing/managing-billing-for-github-actions/about-billing-for-github-actions")ã€‚

è€Œå¯¹äºå…¶ä»–æˆ‘ç”¨è¿‡çš„**CICD å·¥å…·**åŠå…¶æ²¡è¢«é€‰ä¸ºæœ¬æ–‡å®ç°æ–¹å¼çš„åŸå› å¦‚ä¸‹æ‰€ç¤ºï¼š

-   **`Gitlab CI`**ï¼šä¸`Gitlab`é«˜åº¦ç»‘å®šï¼Œé¡¹ç›®æ”¾åœ¨`Gitlab`å°±è°ˆä¸ä¸Šå¼€æºäº†
-   **`Travic CI`**ï¼šé™æ—¶å…è´¹ï¼Œè¿‡åæŒ‰è¿›ç¨‹æ”¶è´¹
-   **`Drone CI`**ï¼šæ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå›½å†…æœºå™¨ä»`Github`æ‹‰å–ä»“åº“ä»£ç æ—¶ä¼šå¶å°”è¶…æ—¶ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡å¤±è´¥
-   **`Jenkins CI`**ï¼šé™¤äº†å­˜åœ¨ä¸`Drone CI`ä¸€æ ·çš„ç¼ºç‚¹å¤–ï¼Œè‡ªèº«æ¯”è¾ƒé‡é‡ï¼Œå ç”¨å®¿ä¸»æœºè¾ƒå¤šèµ„æº

# `Github Action`åˆå­¦å…¥é—¨ï¼ˆç†Ÿæ‚‰çš„å¯è·³è¿‡æ­¤ç« èŠ‚ï¼‰

å½“æˆ‘ä»¬æƒ³å¾€è‡ªå·±çš„é¡¹ç›®é‡Œæ¥å…¥**Github Actions**æ—¶ï¼Œè¦åœ¨æ ¹é¡¹ç›®ç›®å½•é‡Œæ–°å»º`.github/workflows`ç›®å½•ã€‚ç„¶åé€šè¿‡ç¼–å†™`yml`æ ¼å¼æ–‡ä»¶å®šä¹‰**Workflow(å·¥ä½œæµç¨‹)**å»å®ç°`CI`ã€‚åœ¨é˜…è¯»`yml`æ–‡ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆææ‡‚åœ¨**Workflow**ä¸­ä¸€äº›æ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼š

-   **Event(è§¦å‘äº‹ä»¶)**ï¼šæŒ‡è§¦å‘ **Workflow(å·¥ä½œæµç¨‹)** è¿è¡Œçš„äº‹ä»¶ã€‚
-   **Job(ä½œä¸š)**ï¼šä¸€ä¸ª**å·¥ä½œæµç¨‹**ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª**Job**ï¼Œè¿™äº›**Job**é»˜è®¤æƒ…å†µä¸‹å¹¶è¡Œè¿è¡Œï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®è®©å…¶æŒ‰é¡ºåºæ‰§è¡Œã€‚æ¯ä¸ª**Job**éƒ½åœ¨æŒ‡å®šçš„ç¯å¢ƒ(è™šæ‹Ÿæœºæˆ–å®¹å™¨)é‡Œå¼€å¯ä¸€ä¸ª**Runner**(å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¿›ç¨‹)è¿è¡Œï¼ŒåŒ…å«å¤šä¸ª**Step(æ­¥éª¤)**ã€‚
-   **Step(æ­¥éª¤)**ï¼š**Job**çš„ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºå®šä¹‰æ¯ä¸€éƒ¨çš„å·¥ä½œå†…å®¹ã€‚æ¯ä¸ª**Step**åœ¨è¿è¡Œå™¨ç¯å¢ƒä¸­ä»¥å…¶å•ç‹¬çš„è¿›ç¨‹è¿è¡Œï¼Œä¸”å¯ä»¥è®¿é—®å·¥ä½œåŒºå’Œæ–‡ä»¶ç³»ç»Ÿã€‚

ä»¥ä¸‹å›¾çš„`Workflow`ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥æ›´ç›´è§‚åœ°çœ‹æ‡‚**Event**ã€**Job**ä»¥åŠ**Step**ä¸¤è€…çš„å…³ç³»ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27deef91333747ab8f7e09bd2649b5bb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

_åœ¨`Github Action`ä¸­ï¼Œ **Job** å’Œ **Step** ä»¥åŠ **Workflow** éƒ½æœ‰èµ„æºå ç”¨ä»¥åŠæ—¶é—´é™åˆ¶ï¼Œè¶…å‡ºé™åˆ¶å°±ä¼šç›´æ¥å–æ¶ˆè¿è¡Œï¼Œå…³äºè¿™äº›é™åˆ¶å¯çœ‹[Usage limits](https://docs.github.com/cn/actions/learn-github-actions/usage-limits-billing-and-administration#usage-limits "https://docs.github.com/cn/actions/learn-github-actions/usage-limits-billing-and-administration#usage-limits")ã€‚_

ä¸‹é¢æˆ‘ä»¬ç”¨`Github`çš„å®˜æ–¹æ•™ç¨‹ä¸­çš„ä¸€ä¸ª`Workflow`ä¾‹å­æ¥å­¦ä¹ ï¼š

```yml
# æŒ‡å®šå·¥ä½œæµç¨‹çš„åç§°
name: learn-github-actions
# æŒ‡å®šæ­¤å·¥ä½œæµç¨‹çš„è§¦å‘äº‹ä»¶Eventã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ æ¨é€ äº‹ä»¶ï¼Œå³æ‰§è¡Œpushåï¼Œè§¦å‘è¯¥æµæ°´çº¿çš„æ‰§è¡Œ
on: [push]
# å­˜æ”¾ learn-github-actions å·¥ä½œæµç¨‹ä¸­çš„æ‰€æœ‰Job
jobs:
  # æŒ‡å®šä¸€ä¸ªJobçš„åç§°ä¸ºcheck-bats-version
  check-bats-version:
    # æŒ‡å®šè¯¥Jobåœ¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux çš„ Runner(è¿è¡Œå™¨)ä¸Šè¿è¡Œ
    runs-on: ubuntu-latest
    # å­˜æ”¾ check-bats-version ä½œä¸šä¸­çš„æ‰€æœ‰Step
    steps:
      # step-no.1: è¿è¡Œactions/checkout@v3æ“ä½œï¼Œæ“ä½œä¸€èˆ¬ç”¨usesæ¥è°ƒç”¨ï¼Œ
      # ä¸€èˆ¬ç”¨äºå¤„ç†ä¸€äº›å¤æ‚åˆé¢‘ç¹çš„æ“ä½œä¾‹å¦‚æ‹‰å–åˆ†æ”¯ï¼Œå®‰è£…æ’ä»¶
      # æ­¤å¤„ actions/checkout æ“ä½œæ˜¯ä»ä»“åº“æ‹‰å–ä»£ç åˆ°Runneré‡Œçš„æ“ä½œ
      - uses: actions/checkout@v3
      # step-no.2: actions/setup-node@v3 æ“ä½œæ¥å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Node.jsï¼Œæ­¤å¤„æŒ‡å®šå®‰è£…çš„ç‰ˆæœ¬ä¸ºv14
      - uses: actions/setup-node@v3
        with:
          node-version: "14"
      # step-no.3: è¿è¡Œå‘½ä»¤è¡Œä¸‹è½½batsä¾èµ–åˆ°å…¨å±€ç¯å¢ƒä¸­
      - run: npm install -g bats
      # step-no.4: è¿è¡Œå‘½ä»¤è¡ŒæŸ¥çœ‹batsä¾èµ–çš„ç‰ˆæœ¬
      - run: bats -v
```

æ•´ä¸ª`learn-github-actions`**å·¥ä½œæµç¨‹**å¼„æˆæµç¨‹å›¾å¯å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf3432f09abe493cbc5a96a94c34a441~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

# åŸºç¡€ç¯‡ï¼šæ¥ç»™ä¸€ä¸ªé¡¹ç›®æ·»åŠ `CICD`æµç¨‹

## åˆå§‹åŒ–é¡¹ç›®

ä¸ºäº†è®©è¯»è€…æ›´å¤šåœ°ä¸“æ³¨äº`CICD`çš„å®ç°ç»†èŠ‚ï¼Œè¿™é‡Œæˆ‘ç”¨`Vite`çš„[åˆ›å»ºæŒ‡ä»¤](https://vitejs.cn/guide/#scaffolding-your-first-vite-project "https://vitejs.cn/guide/#scaffolding-your-first-vite-project")ç®€å•æ–°å»ºä¸€ä¸ªé¡¹ç›®ã€‚é€šè¿‡`yarn create vite cicd-study --template react-ts`åˆ›å»ºä¸€ä¸ªæŠ€æœ¯æ ˆä¸º`Vite`ã€`React`ã€`Typescript`çš„å‰ç«¯é¡¹ç›®ï¼Œå®‰è£…ä¾èµ–åè¿è¡Œèµ·æ¥çš„é¡µé¢æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![vite-react-ts.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49744ea6dcd24fa2870900518f1371bf~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

è¯»è€…ä¹Ÿå¯ä»¥é€šè¿‡[stackblitz](https://stackblitz.com/edit/vitejs-vite-rfo4fe?file=index.html&terminal=dev "https://stackblitz.com/edit/vitejs-vite-rfo4fe?file=index.html&terminal=dev")æŸ¥çœ‹é¡¹ç›®çš„ç›®å½•ç»“æ„å’Œæ–‡ä»¶ä»£ç ã€‚

æ¥ä¸‹æ¥ä¼šåœ¨è¿™ä¸ªé¡¹ç›®ä¸Šæ·»åŠ `CI`å’Œ`CD`æµç¨‹ã€‚å®Œæ•´é¡¹ç›®åœ°å€å¯çœ‹[ciccd-study](https://github.com/Hitotsubashi/cicd-study "https://github.com/Hitotsubashi/cicd-study")ã€‚

## æ·»åŠ `CI`æµç¨‹

### `CI`çš„æ¦‚å¿µ

**CI**çš„å…¨ç§°æ˜¯**Continuous Integration**ï¼Œç›´è¯‘ä¸º**å¯æŒç»­é›†æˆ**ï¼Œè€Œæ™®éå¯¹å…¶çš„è§£é‡Šæ˜¯**é¢‘ç¹åœ°ï¼ˆä¸€å¤©å¤šæ¬¡ï¼‰å°†ä»£ç é›†æˆåˆ°ä¸»å¹²**ã€‚å¯¹äºè¿™ä¸ªè§£é‡Šæˆ‘ä»¬è¦ææ‡‚å…¶ä¸­çš„ä¸¤ä¸ªæ¦‚å¿µï¼š

1.  **ä¸»å¹²**ï¼šæ˜¯æŒ‡åŒ…å«å¤šä¸ªå·²ä¸Šå’Œå³å°†ä¸Šçº¿çš„ç‰¹æ€§çš„åˆ†æ”¯ã€‚
2.  **é›†æˆ**ï¼šæ˜¯æŒ‡æŠŠå«æ–°ç‰¹æ€§çš„åˆ†æ”¯åˆå¹¶(`merge`)åˆ°**ä¸»å¹²**ä¸Šçš„è¡Œä¸º

æˆ‘ä»¬å€Ÿ`github flow`åˆ†æ”¯ç®¡ç†ç­–ç•¥ä½œä¸ºä¾‹å­æ¥æ›´åŠ æ·±å…¥äº†è§£`CI`åŠä¸Šé¢çš„ä¸¤ä¸ªæ¦‚å¿µï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e231ae5101154085bcb13b18443c5e2d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

`github flow`åœ¨å¼€å‘æ–°ç‰¹æ€§çš„è¿è¡Œæ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

1.  åŸºäº`master`åˆ›å»ºæ–°çš„åˆ†æ”¯`feature`è¿›è¡Œå¼€å‘ã€‚æ³¨æ„è¿™éœ€è¦ä¿è¯`master`çš„ä»£ç å’Œç‰¹æ€§æ°¸è¿œæ˜¯æœ€ç¨³å®šçš„ã€‚
2.  å¼€å‘æœŸé—´ï¼Œå®šæœŸæäº¤æ›´æ”¹(`commit and push change`)åˆ°è¿œç¨‹ä»“åº“çš„`feature`åˆ†æ”¯
3.  åœ¨ç¼–ç ä»¥åŠè‡ªæµ‹å®Œæˆåï¼Œé€šè¿‡åˆ›å»º`pull request`å»å¯¹`master`å‘èµ·åˆå¹¶`feature`çš„è¯·æ±‚
4.  `pull request`åœ¨ç»è¿‡å®¡æ ¸ç¡®è®¤å¯è¡Œååˆå¹¶åˆ°`master`åˆ†æ”¯
5.  åˆ é™¤å·²åˆå¹¶çš„ç‰¹æ€§åˆ†æ”¯`feature`

æ›´å¤šè¯¦ç»†ç»†èŠ‚å¯çœ‹[GitHub flow](https://docs.github.com/cn/get-started/quickstart/github-flow "https://docs.github.com/cn/get-started/quickstart/github-flow")ã€‚

åœ¨`github Flow`æ¨¡å‹ä¸­ï¼Œ**ä¸»å¹²**æŒ‡`master`åˆ†æ”¯ï¼Œå¹¿ä¹‰ä¸Šæ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå·²ä¸Šå’Œå³å°†ä¸Šçº¿çš„ç‰¹æ€§çš„åˆ†æ”¯ï¼›**é›†æˆ**æŒ‡çš„æ˜¯åœ¨`pull request`é€šè¿‡åæŠŠç‰¹æ€§åˆ†æ”¯`merge`åˆå¹¶åˆ°**ä¸»å¹²**ï¼Œä¹Ÿå°±æ˜¯`master`åˆ†æ”¯ä¸Šã€‚

é˜®ä¸€å³°è€å¸ˆçš„[æŒç»­é›†æˆæ˜¯ä»€ä¹ˆï¼Ÿ](https://www.ruanyifeng.com/blog/2015/09/continuous-integration.html "https://www.ruanyifeng.com/blog/2015/09/continuous-integration.html")é‡Œè¯´åˆ°è¿‡ï¼š

> æŒç»­é›†æˆçš„ç›®çš„ï¼Œå°±æ˜¯è®©äº§å“å¯ä»¥å¿«é€Ÿè¿­ä»£ï¼ŒåŒæ—¶è¿˜èƒ½ä¿æŒé«˜è´¨é‡ã€‚å®ƒçš„æ ¸å¿ƒæªæ–½æ˜¯ï¼Œä»£ç é›†æˆåˆ°ä¸»å¹²ä¹‹å‰ï¼Œå¿…é¡»é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚åªè¦æœ‰ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹å¤±è´¥ï¼Œå°±ä¸èƒ½é›†æˆã€‚

è€Œ`github flow`æ¨¡å‹**ä¿è¯é«˜è´¨é‡çš„æ ¸å¿ƒæªæ–½**æ˜¯ï¼šåœ¨**é›†æˆ**å‰é€šè¿‡`pull request`ï¼Œä»è€Œè§¦å‘å®¡æ ¸ï¼ˆå®¡æ ¸å¯ä»¥æ˜¯ä¸€ç³»åˆ—çš„è‡ªåŠ¨åŒ–æ ¡éªŒæµ‹è¯•ä»¥åŠä»£ç å®¡æ ¸**Code Review**ï¼‰ï¼Œåœ¨å®¡æ ¸é€šè¿‡åå†åˆå¹¶åˆ°**ä¸»å¹²**ï¼Œä»è€Œä¿è¯**ä¸»å¹²**çš„ç¨³å®šæ€§ã€‚

ä¸‹é¢æˆ‘ä»¬å°±æŒ‰ç…§`github flow`æ¨¡å‹çš„æœºåˆ¶ï¼Œåœ¨å¼€å¤´åˆ›å»ºçš„é¡¹ç›®ä¸Šæ·»åŠ `CI`æµç¨‹ã€‚

### åœ¨é¡¹ç›®ä¸­å®ç°`CI`

æ ¹æ®ä¸Šé¢æ‰€è¯´çš„`github flow`æ¨¡å‹**ä¿è¯é«˜è´¨é‡çš„æ ¸å¿ƒæªæ–½**å¯çŸ¥ï¼Œæˆ‘ä»¬è¦å®šä¹‰çš„æ‰§è¡Œ`CI`çš„**Workflow**ï¼ˆä¸‹ç§°**CI Workflow**ï¼‰çš„**Event**æ˜¯`master`åˆ†æ”¯çš„`pull request`äº‹ä»¶ã€‚è€Œ`Job`å’Œ`Step`çš„è¯æ²¡å…·ä½“è¯´æ˜ï¼Œè€Œæˆ‘ä»¬å¯ä»¥æŠŠç›®å‰æœ€æ™®éçš„ **ä»£ç æµ‹è¯•ï¼ˆTestï¼‰** å’Œ **ä»£ç æ‰«æï¼ˆLintï¼‰** åŠ å…¥å…¶ä¸­ã€‚

å…¶å®ç°æ€è·¯æ˜¯ï¼Œé¦–å…ˆè¦å€ŸåŠ©ä¸€äº›ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œåœ¨`package.json`ä¸­çš„`scripts`å®šä¹‰å¯ä»¥æ‰§è¡Œ**ä»£ç æµ‹è¯•ï¼ˆTestï¼‰**å’Œ**ä»£ç æ‰«æï¼ˆLintï¼‰**çš„å‘½ä»¤ï¼Œç„¶ååœ¨æŠŠè¿™äº›å‘½ä»¤è¡ŒåŠ åˆ°**CI Workflow**çš„**Step**é‡Œã€‚

å…·ä½“æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8cd2441838274ff39f63af4fccb134a4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

#### ä»£ç æ‰«æå‘½ä»¤å®ç°

ä¸€èˆ¬å…¬å¸é‡Œéƒ½ä¼šé€šè¿‡ç±»ä¼¼`Sonar`è¿™ç±»ä»£ç è´¨é‡ç®¡ç†æ’ä»¶æ¥ä¿è¯ä»£ç è´¨é‡ã€‚ä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å‰ç«¯æ ·å¼ä¸‰å‰‘ä¾ ï¼š`eslint`+`prettier`+`stylelint`æ¥ç®€å•ä¿è¯ã€‚è¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨æœ¬äººæ¯”è¾ƒå–œå¥½å’Œç»å¸¸ä½¿ç”¨çš„`umi`çš„ä»£ç è§„èŒƒï¼š[**@umijs/fabric**](https://github.com/umijs/fabric "https://github.com/umijs/fabric")æ¥è§„å®šä¸‰å‰‘ä¾ çš„è§„åˆ™äº†ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

**.eslintrc.js**

```js
module.exports = {
  extends: [require.resolve("@umijs/fabric/dist/eslint")],
};
```

**.prettierrc.js**

```js
const fabric = require("@umijs/fabric");

module.exports = {
  ...fabric.prettier,
};
```

**.stylelintrc.js**

```js
const fabric = require("@umijs/fabric");

module.exports = {
  ...fabric.stylelint,
};
```

ç„¶ååœ¨`package.json`çš„`script`ä¸ŠåŠ ä¸Šå¯¹åº”çš„æ‰§è¡Œå‘½ä»¤å³å¯ï¼š

```json
"scripts": {
  "dev": "vite",
  "build": "tsc && vite build",
  "preview": "vite preview",
  "lint": "npm run lint:js && npm run lint:style && npm run lint:prettier",
  "lint:js": "eslint --cache --ext .js,.jsx,.ts,.tsx ./src",
  "lint:prettier": "prettier --check \"src/**/*\" --end-of-line auto",
  "lint:style": "stylelint --fix 'src/**/*.{css,scss,less}' --cache"
}
```

è¿™æ ·å­å°±å®Œæˆäº†**ä»£ç æ‰«æ**éƒ¨åˆ†äº†ã€‚é€šè¿‡`yarn run lint`æ‰§è¡Œåçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed18411c0d2c41108d62ab0fd1716779~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

#### è‡ªåŠ¨åŒ–æµ‹è¯•å‘½ä»¤å®ç°

å‰ç«¯æµ‹è¯•ä¸»è¦æœ‰**å•å…ƒæµ‹è¯•ï¼ˆUnit Testï¼‰**ã€**é›†æˆæµ‹è¯•ï¼ˆIntegration Testï¼‰**ã€**UI æµ‹è¯•ï¼ˆUI Testï¼‰**ã€‚ç”±äºé¡¹ç›®é‡Œåªæœ‰ä¸€ä¸ªé¡µé¢ç»„ä»¶ï¼Œä¸”æœ¬ç« èŠ‚çš„é‡ç‚¹æ˜¯å®ç°`CI`è€Œä¸æ˜¯**å‰ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼Œå› æ­¤è¿™é‡Œç”¨**å•å…ƒæµ‹è¯•**æ¥å®ç°ä¸€ä¸‹ï¼š

ä¸ºäº†å¤šå†™ç‚¹æµ‹è¯•ç”¨ä¾‹ç»™æµ‹è¯•ä»£ç åŠ ç‚¹å†…å®¹ï¼Œæˆ‘ç»™é¡µé¢å¯¹åº”ç»„ä»¶`App.tsx`åŠ äº†ä¸ª`props`ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

**App.tsx**

```tsx
import type { FC } from "react";
import { useState } from "react";
import logo from "./logo.svg";
import "./App.css";

interface Props {
  value: string;
}

const App: FC<Props> = ({ value }) => {
  const [count, setCount] = useState(0);

  return (
    <div className="App">
      <header className="App-header">
        <img src={logo} className="App-logo" alt="logo" />
        <p>Hello Vite + React!!!!!!!!</p>
        <p>
          {/*
            æµ‹è¯•ä»£ç ä¸­éœ€è¦è·å–çš„DOMå…ƒç´ ç”¨roleå±æ€§æ ‡è®°ï¼Œè¿™é‡Œçš„roleå±æ€§åªä¼šåœ¨æµ‹è¯•ä»£ç ä¸­ç”¨åˆ°ï¼Œ
            è¿™æ ·å­å°±å¯ä»¥é¿å…ä»£ç å› éœ€æ±‚æ”¹åŠ¨æ—¶ï¼Œå› DOMå±æ€§æ”¹å˜å¯¼è‡´æµ‹è¯•ä¸é€šè¿‡ã€‚æœ‰åˆ©äºTDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰å¼€å‘çš„è¿›è¡Œ
          */}
          <button
            role="button"
            type="button"
            onClick={() => setCount((v) => v + 1)}
          >
            count is: {count}
          </button>
        </p>
        <p role="props">{value}</p>
      </header>
    </div>
  );
};

export default App;
```

è¿™é‡Œé‡‡ç”¨`ts-jest`+`@testing-library`æ¥ç¼–å†™æµ‹è¯•ä»£ç ï¼ˆå½“ç„¶å¯¹äº`React`è¿˜æœ‰åˆ«çš„é€‰æ‹©ï¼Œä¾‹å¦‚`ts-jest`+`enzyme`ï¼‰ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

**App.test.tsx**

```ts
import React from "react";
import { render, screen, fireEvent } from "@testing-library/react";
import App from "./App";

test("props is avaliable", () => {
  const value = "123";
  // ä¸ºäº†å¤šå†™ç‚¹æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ç»™Appç»„ä»¶åŠ äº†ä¸ªprop
  render(<App value={value} />);
  expect(screen.getByRole("props")).toHaveTextContent(value);
});

test("click of button is avaliable", () => {
  render(<App value="123" />);
  fireEvent.click(screen.getByRole("button"));
  expect(screen.getByRole("button")).toHaveTextContent(`count is: 1`);
});
```

`jest.config.js`çš„é…ç½®æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥ä»[æ­¤å¤„](https://github.com/Hitotsubashi/cicd-study/blob/main/jest.config.js "https://github.com/Hitotsubashi/cicd-study/blob/main/jest.config.js")æŸ¥çœ‹ã€‚é…ç½®å¥½åè¿è¡Œ`yarn test`åæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/916b1e12446b45f796f1cc376d635af1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

#### é…ç½®**CI Workflow**

åœ¨é¡¹ç›®æ ¹ç›®å½•é‡Œçš„`.github/workflows`æ–‡ä»¶å¤¹ä¸Šæ–°å»º`ci.yml`ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

**ci.yml**

```yml
name: CI
# Eventè®¾ç½®ä¸ºmainåˆ†æ”¯çš„pull requestäº‹ä»¶ï¼Œ
# è¿™é‡Œçš„mainåˆ†æ”¯ç›¸å½“äºmasteråˆ†æ”¯ï¼Œgithubé¡¹ç›®æ–°å»ºæ˜¯æŠŠmainè®¾ç½®ä¸ºé»˜è®¤åˆ†æ”¯ï¼Œæˆ‘æ‡’å¾—æ”¹äº†æ‰€ä»¥å°±ä¿æŒè¿™æ ·å§
on:
  pull_request:
    branches: main
jobs:
  # åªéœ€è¦å®šä¹‰ä¸€ä¸ªjobå¹¶å‘½åä¸ºCI
  CI:
    runs-on: ubuntu-latest
    steps:
      # æ‹‰å–é¡¹ç›®ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v2
      # ç»™å½“å‰ç¯å¢ƒä¸‹è½½node
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16.x"
      # æ£€æŸ¥ç¼“å­˜
      # å¦‚æœkeyå‘½ä¸­ç¼“å­˜åˆ™ç›´æ¥å°†ç¼“å­˜çš„æ–‡ä»¶è¿˜åŸåˆ° path ç›®å½•ï¼Œä»è€Œå‡å°‘æµæ°´çº¿è¿è¡Œæ—¶é—´
      # è‹¥ key æ²¡å‘½ä¸­ç¼“å­˜æ—¶ï¼Œåœ¨å½“å‰JobæˆåŠŸå®Œæˆæ—¶å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°ç¼“å­˜
      - name: Cache
        # ç¼“å­˜å‘½ä¸­ç»“æœä¼šå­˜å‚¨åœ¨steps.[id].outputs.cache-hité‡Œï¼Œè¯¥å˜é‡åœ¨ç»§åçš„stepä¸­å¯è¯»
        id: cache-dependencies
        uses: actions/cache@v3
        with:
          # ç¼“å­˜æ–‡ä»¶ç›®å½•çš„è·¯å¾„
          path: |
            **/node_modules
          # keyä¸­å®šä¹‰ç¼“å­˜æ ‡å¿—ä½çš„ç”Ÿæˆæ–¹å¼ã€‚runner.OSæŒ‡å½“å‰ç¯å¢ƒçš„ç³»ç»Ÿã€‚å¤–åŠ å¯¹yarn.lockå†…å®¹ç”Ÿæˆå“ˆå¸Œç ä½œä¸ºkeyå€¼ï¼Œå¦‚æœyarn.lockæ”¹å˜åˆ™ä»£è¡¨ä¾èµ–æœ‰å˜åŒ–ã€‚
          # è¿™é‡Œç”¨yarn.lockè€Œä¸æ˜¯package.jsonæ˜¯å› ä¸ºpackage.jsonä¸­è¿˜æœ‰versionå’Œdescriptionä¹‹ç±»çš„æè¿°é¡¹ç›®ä½†å’Œä¾èµ–æ— å…³çš„å±æ€§
          key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
      # å®‰è£…ä¾èµ–
      - name: Installing Dependencies
        # å¦‚æœç¼“å­˜æ ‡å¿—ä½æ²¡å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œè¯¥stepã€‚å¦åˆ™å°±è·³è¿‡è¯¥step
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: yarn install
      # è¿è¡Œä»£ç æ‰«æ
      - name: Running Lint
        # é€šè¿‡å‰é¢ç« èŠ‚å®šä¹‰çš„å‘½ä»¤è¡Œæ‰§è¡Œä»£ç æ‰«æ
        run: yarn lint
      # è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
      - name: Running Test
        # é€šè¿‡å‰é¢ç« èŠ‚å®šä¹‰çš„å‘½ä»¤è¡Œæ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
        run: yarn test
```

å…³äºä¸Šé¢çš„`Cahe`æ­¥éª¤ä¸­ï¼Œ7 å¤©å†…æœªè¢«è®¿é—®çš„ä»»ä½•ç¼“å­˜æ¡ç›®å°†ä¼šè¢«åˆ é™¤ã€‚ å¯ä»¥å­˜å‚¨çš„ç¼“å­˜æ•°æ²¡æœ‰é™åˆ¶ï¼Œä½†å­˜å‚¨åº“ä¸­æ‰€æœ‰ç¼“å­˜çš„æ€»å¤§å°é™åˆ¶ä¸º 10 GBã€‚æ›´å¤šå†…å®¹è¯·çœ‹[ç¼“å­˜ä¾èµ–é¡¹ä»¥åŠ å¿«å·¥ä½œæµç¨‹](https://docs.github.com/cn/actions/using-workflows/caching-dependencies-to-speed-up-workflows "https://docs.github.com/cn/actions/using-workflows/caching-dependencies-to-speed-up-workflows")ã€‚

* * *

å½“åˆ›å»º`pull request`åˆå¹¶åˆ°ä¸»å¹²æ—¶ï¼Œ**CI Workflow**è§¦å‘è¿è¡Œï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æƒ…å†µï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da87fc3688394d11a1be7391721250e1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å½“**CI Workflow**è¿è¡Œå®Œæˆæ—¶ï¼Œå…¶æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f59410d312a4dc8aa517701f98a94b7~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‚¹å‡»`Details`æŸ¥çœ‹æ‰§è¡Œè¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a907606f73e4894a13fc72d4f9bb731~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ä¹Ÿå¯ä»¥ç‚¹å¼€æ¯ä¸ª`step`æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69118f7b049d4ec0ba3746493be1a653~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ç¡®è®¤ä»£ç å®‰å…¨å¯é åå°±å¯ä»¥ç‚¹å‡»`Merge pull request`æ¥æŠŠæ–°ä»£ç **é›†æˆ**åˆ°**ä¸»å¹²**ä¸Šã€‚ä»è€ŒåŸºäº`CI`å®Œæˆä¸€æ¬¡**bug ä¿®å¤**æˆ–**æ–°ç‰¹æ€§è¿­ä»£**ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcecb9fa1df148f291d0ce40fe88a5f6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

åˆå¹¶æˆåŠŸåï¼Œå¯ä»¥ç‚¹å‡»`Delete branch`ä»¥åˆ é™¤å·²åˆå¹¶çš„ç‰¹æ€§åˆ†æ”¯ã€‚

### è¡¥å……

éƒ¨åˆ†`DevOps`å¹³å°ä¸­çš„`CI`æµç¨‹æ¯”ä¸Šé¢æˆ‘ä»¬å®ç°çš„æµç¨‹é‡Œå¤šä¸€ä¸ªé˜¶æ®µï¼š**ç¼–è¯‘å¹¶æ•´ç†äº§ç‰©**ï¼Œå³åŸºäºå½“å‰ç‰ˆæœ¬çš„ä»£ç æ‰“åŒ…æ„å»ºäº§ç‰©ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘æŠŠè¿™ä¸ªé˜¶æ®µæ”¾åœ¨`CD`æµç¨‹é‡Œã€‚

## æ·»åŠ `CD`æµç¨‹

### `CD`çš„æ¦‚å¿µ

`CD`æŒ‡çš„æ˜¯ **æŒç»­äº¤ä»˜ï¼ˆContinuous deliveryï¼‰** æˆ–è€… **æŒç»­éƒ¨ç½²ï¼ˆcontinuous deploymentï¼‰** æˆ–è€…æ˜¯ä¸¤è€…çš„å¹¶é›†ï¼Œæˆ‘ä»¬å€Ÿç”¨[AWS ä¸­å¯¹æŒç»­äº¤ä»˜è¯´æ˜](https://aws.amazon.com/cn/devops/continuous-delivery/ "https://aws.amazon.com/cn/devops/continuous-delivery/")æ¥è¯´æ˜ä¸‹è¿™ä¸¤è€…çš„è§£é‡Šï¼Œå¦‚ä¸‹ï¼š

> ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/539a9328755340e69a1fa5d50abd3bb5~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?) é‡‡ç”¨æŒç»­äº¤ä»˜æ—¶ï¼Œç³»ç»Ÿä¼šæ„å»ºå¹¶æµ‹è¯•æ¯ä¸€ä¸ªä»£ç å˜æ›´ï¼Œç„¶åå°†å…¶æ¨é€åˆ°éç”Ÿäº§æµ‹è¯•ç¯å¢ƒæˆ–ä¸´æ—¶ç¯å¢ƒä¸­ã€‚ç”Ÿäº§éƒ¨ç½²å‰å¯èƒ½å­˜åœ¨å¤šä¸ªå¹¶è¡Œæµ‹è¯•é˜¶æ®µã€‚**æŒç»­äº¤ä»˜ä¸æŒç»­éƒ¨ç½²ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œéœ€è¦æ‰‹åŠ¨æ‰¹å‡†æ‰èƒ½æ›´æ–°åˆ°ç”Ÿäº§ç¯å¢ƒã€‚å¯¹äºæŒç»­éƒ¨ç½²ï¼Œç”Ÿäº§ä¼šåœ¨æ²¡æœ‰æ˜ç¡®æ‰¹å‡†çš„æƒ…å†µä¸‹è‡ªåŠ¨å‘ç”Ÿã€‚**

ä»ä¸Šé¢çš„è§£é‡Šä¸­å¯çŸ¥å…¶æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š

1.  ç”Ÿæˆåˆ¶å“
2.  è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒä»¥æ ¡éªŒå…¶ç¨³å®šæ€§
3.  éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè‡ªåŠ¨çš„æ˜¯**æŒç»­éƒ¨ç½²**ï¼Œæ‰‹åŠ¨çš„æ˜¯**æŒç»­äº¤ä»˜**ï¼‰

åŸºäºæœ¬æ–‡æ˜¯ä»¥å…¥é—¨ä¸ºä¸»ï¼Œä¸”å¾ˆå¤šè¯»è€…ä¹Ÿå°±åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨æ¥ç›´æ¥éƒ¨ç½²è‡ªå·±çš„å°é¡¹ç›®ï¼Œå› æ­¤æœ¬ç« èŠ‚çš„`CD`å®ç°ä¸­ï¼Œæˆ‘ä»¬ä»¥**æŒç»­éƒ¨ç½²ï¼ˆcontinuous deploymentï¼‰** ä¸”è·³è¿‡ä¸Šé¢ç¬¬äºŒæ­¥æ¥å®ç°ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆåˆ¶å“åç›´æ¥è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

* * *

å…¶å®å¯¹äº**æŒç»­äº¤ä»˜ï¼ˆContinuous deliveryï¼‰** å’Œ **æŒç»­éƒ¨ç½²ï¼ˆcontinuous deploymentï¼‰** ï¼Œä¸åŒ`DevOps`å¹³å°æœ‰ä¸åŒçš„è§£é‡Šï¼Œè€Œä¸åŒçš„ä¼ä¸šå’Œé¡¹ç›®ä¹Ÿæœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚ä½†æœ¬è´¨ä¸Šä¸ä¼šæœ‰å¤ªå¤§åŒºåˆ«ï¼Œè€Œæˆ‘ä»¬ä¹Ÿæ²¡å¿…è¦å»èŠ±æ—¶é—´å’¬æ–‡åš¼å­—ï¼Œå€Ÿç”¨**Red Hat**å¯¹ [**CICD**è¯´æ˜](https://www.redhat.com/zh/topics/devops/what-is-ci-cd "https://www.redhat.com/zh/topics/devops/what-is-ci-cd") é‡Œçš„ä¸€å¥è¯æ€»ç»“ï¼Œå¦‚ä¸‹ï¼š

> CI/CD æ—¢å¯èƒ½ä»…æŒ‡æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜æ„æˆçš„å…³è”ç¯èŠ‚ï¼Œä¹Ÿå¯ä»¥æŒ‡æŒç»­é›†æˆã€æŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²è¿™ä¸‰é¡¹æ„æˆçš„å…³è”ç¯èŠ‚ã€‚æ›´ä¸ºå¤æ‚çš„æ˜¯ï¼Œæœ‰æ—¶"æŒç»­äº¤ä»˜"ä¹ŸåŒ…å«äº†æŒç»­éƒ¨ç½²æµç¨‹ã€‚
> 
> å½’æ ¹ç»“åº•ï¼Œæˆ‘ä»¬æ²¡å¿…è¦çº ç»“äºè¿™äº›è¯­ä¹‰ï¼Œæ‚¨åªéœ€è®°å¾— CI/CD å…¶å®å°±æ˜¯ä¸€ä¸ªæµç¨‹ï¼ˆé€šå¸¸å½¢è±¡åœ°è¡¨è¿°ä¸ºç®¡é“ï¼‰ï¼Œç”¨äºå®ç°åº”ç”¨å¼€å‘ä¸­çš„é«˜åº¦æŒç»­è‡ªåŠ¨åŒ–å’ŒæŒç»­ç›‘æ§ã€‚å› æ¡ˆä¾‹è€Œå¼‚ï¼Œè¯¥æœ¯è¯­çš„å…·ä½“å«ä¹‰å–å†³äº CI/CD ç®¡é“çš„è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚è®¸å¤šä¼ä¸šæœ€å¼€å§‹å…ˆæ·»åŠ  CIï¼Œç„¶åé€æ­¥å®ç°äº¤ä»˜å’Œéƒ¨ç½²çš„è‡ªåŠ¨åŒ–ï¼ˆä¾‹å¦‚ä½œä¸ºäº‘åŸç”Ÿåº”ç”¨çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚

### åœ¨é¡¹ç›®ä¸­å®ç°`CD`

è¿™æ˜¯æˆ‘ä»¬åœ¨æœ¬ç« èŠ‚è¦å®ç°çš„`CD`æœºåˆ¶çš„æµç¨‹å›¾ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34de1e458c6e4f5f9429ca6251272a77~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

#### å…ˆå‰å‡†å¤‡

åœ¨ç¼–å†™**CD Workflow**å‰ï¼Œæˆ‘ä»¬è¦å‡†å¤‡ä»¥ä¸‹ä¸œè¥¿ï¼š

1.  å†…ç½®`nginx`çš„æœåŠ¡å™¨ä¸€å°ï¼šç”¨äºéƒ¨ç½²åˆ¶å“
2.  æœåŠ¡å™¨çš„å¯†é’¥å¯¹ï¼šç”¨äºæä¾›ç»™æµæ°´çº¿é€šè¿‡ ssh å…å¯†ç™»å½•åˆ°æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²
3.  `Github`é‡Œçš„**Personal Access Token**ï¼šç”¨äºæä¾›ç»™æµæ°´çº¿å…å¯†ç™»å½•`github`è´¦å·è¿›è¡Œå‘å¸ƒåˆ¶å“çš„æ“ä½œ
4.  æŠŠæ­¥éª¤ 2 å’Œæ­¥éª¤ 3 åŠå…¶ä»–å…³äºæœºå™¨çš„ä¿¡æ¯éƒ½æ”¾åœ¨å¯¹åº”ä»“åº“çš„**Secret**é‡Œ

ä¸‹é¢å¯¹ä¸Šè¿°éœ€è¦å‡†å¤‡çš„ä¸œè¥¿é€ä¸€è®²è§£ï¼š

1.  **å‡†å¤‡ä¸€å°æœåŠ¡å™¨ï¼Œåœ¨é‡Œé¢å¯åŠ¨`nginx`æœåŠ¡ã€‚**
    
    è¯»è€…å¯ä»¥ç›´æ¥é€šè¿‡`apt`ä¸‹è½½`nginx`åˆ°æŒ‡å®šç›®å½•åå¯åŠ¨ã€‚æˆ‘ä¸ªäººä¹ æƒ¯ä»¥`docker`å¯åŠ¨å®¹å™¨ä»¥å¼€å¯`nginx`æœåŠ¡ã€‚å› æ­¤æˆ‘ç›´æ¥é€šè¿‡ä¸‹é¢çš„`docker-compose.yml`å»åˆ›å»ºå¯åŠ¨`nginx`å®¹å™¨ï¼š
    
    ```yml
    # æŒ‡å®šdocker-composeè§£æçš„ç‰ˆæœ¬
    version: "3"
    services:
      pure-nginx:
        image: nginx:latest
        # æŒ‡å®šå®¹å™¨å
        container_name: pure-nginx
        restart: always
        # æŒ‡å®šæŒä¹…å·ï¼Œæ ¼å¼ä¸º å®¿ä¸»æœºç›®å½•è·¯å¾„:å®¹å™¨ç›®å½•è·¯å¾„
        # CD Workflowä¼šé€šè¿‡å¯†é’¥ç™»å½•è¯¥æœåŠ¡å™¨ï¼Œç„¶åæŠŠç”Ÿæˆçš„åˆ¶å“æ”¾åœ¨/data/wwwé‡Œï¼Œåœ¨æ­¤ä¹‹åç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ipå³å¯è®¿é—®åˆ°é¡¹ç›®é¡µé¢
        volumes:
          - /data/www:/usr/share/nginx/html
        ports:
          - 80:80
    ```
    
2.  **åˆ›å»ºæœåŠ¡å™¨çš„å¯†é’¥å¯¹ï¼šç”¨äºæä¾›ç»™æµæ°´çº¿é€šè¿‡ ssh å…å¯†ç™»å½•åˆ°æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²**
    
    æ¯ä¸ªå¹³å°éƒ½æœ‰åˆ›å»ºå¯†é’¥çš„æ•™ç¨‹ï¼Œä¾‹å¦‚æˆ‘çš„æœºå™¨æ˜¯è…¾è®¯äº‘çš„ï¼Œå› æ­¤å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://cloud.tencent.com/document/product/1207/44573 "https://cloud.tencent.com/document/product/1207/44573")å»åˆ›å»ºå¯†é’¥ï¼Œå¯†é’¥åˆ†å…¬é’¥å’Œç§é’¥ã€‚å…¬é’¥å­˜æ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œç§é’¥æˆ‘ä»¬è‡ªå·±ä¸‹è½½ä¿å­˜ã€‚åœ¨é…ç½®`CD Workflow`çš„å…å¯†ç™»å½•æœºå™¨çš„**æ­¥éª¤ step**ä¹‹å‰ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ä½¿ç”¨å¯†é’¥ç™»å½•](https://cloud.tencent.com/document/product/1207/44643 "https://cloud.tencent.com/document/product/1207/44643")ï¼Œä½¿ç”¨`VSCode`ä¸­çš„[Remote - SSH](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh "https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh")é€šè¿‡é…ç½®ç§é’¥å°è¯•æ˜¯å¦å¯ä»¥å…å¯†ç™»å½•æœºå™¨ï¼Œå¦‚æœæˆåŠŸåå°±å¯ä»¥æ”¾å¿ƒäº¤ç»™æµæ°´çº¿å»ç™»å½•ã€‚
    
3.  **åˆ›å»º`Github`é‡Œçš„ Personal Access Token ï¼šç”¨äºæä¾›ç»™æµæ°´çº¿å…å¯†ç™»å½•`github`è´¦å·è¿›è¡Œå‘å¸ƒåˆ¶å“çš„æ“ä½œ**
    
    å‚è€ƒ`Github`å®˜æ–¹æ–‡æ¡£[Creating a personal access token](https://docs.github.com/cn/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token "https://docs.github.com/cn/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token")åˆ›å»º**Personal Access Token**ã€‚
    
    åœ¨ä¸Šè¿°æ–‡æ¡£é‡Œçš„ç¬¬ 8 æ­¥ **Select scopes** æ—¶ç›´æ¥ç‚¹å‡»`repo`å³å¯ï¼Œå…¶ä½™çš„å¯ä¸é€‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64beb416e2ef41beb21ea45994ff9dcc~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
    
4.  **æŠŠæ­¥éª¤ 2 å’Œæ­¥éª¤ 3 åŠå…¶ä»–å…³äºæœºå™¨çš„ä¿¡æ¯éƒ½æ”¾åœ¨`github`ä»“åº“çš„ Secret é‡Œ**
    
    **Secret**æ˜¯ä¸€äº›ç›¸å¯¹æœºå¯†é‡è¦çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨ **Workflow** é‡Œé¢éœ€è¦ç”¨åˆ°ï¼Œä½†åˆä¸èƒ½ä»¥æ˜æ–‡çš„å½¢å¼ç›´æ¥å†™åœ¨æ–‡ä»¶é‡Œä»¥å…æ³„éœ²ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ”¾åœ¨**Secret**é‡Œï¼Œåœ¨ **Workflow** è¿è¡Œæ—¶è¿™äº›**Secret**ä¼šä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼æ³¨å…¥åˆ°`Runner`é‡Œï¼Œæ­¤æ—¶å¯ä»¥ä»¥`${{ secrets.xxx }}`çš„å½¢å¼è¯»å–ã€‚
    
    åœ¨å¦‚å›¾æ‰€ç¤ºçš„é¡µé¢ä¸‹ç‚¹å‡»å³ä¸Šè§’çš„`New repository secret`å»åˆ›å»º`secret`ï¼Œåœ¨æ¥ä¸‹æ¥è¦åˆ›å»ºçš„`CD Workflow`ä¸­éœ€è¦ç”¨åˆ°å¦‚å›¾çº¢å­—æ ‡è®°æ‰€ç¤ºçš„å››ä¸ª**Secret**ã€‚
    
    ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc7dfad31cd2485490a1170dd9548701~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
    

#### é…ç½®**CD Workflow**

è¿™é‡Œæˆ‘ä»¬æŠŠæ‰§è¡Œ`CD`çš„**Workflow**ï¼ˆä¸‹ç§°**CD Workflow**ï¼‰çš„**Event**å®šä¹‰ä¸º`master`åˆ†æ”¯çš„`push`äº‹ä»¶ï¼Œå› ä¸º**CD Workflow**çš„æ‰§è¡Œæ˜¯åœ¨`Merge pull request`å®Œæˆåçš„ï¼Œè€Œåˆå¹¶è¡Œä¸ºä¼šè§¦å‘**ä¸»å¹²**çš„`push`äº‹ä»¶ã€‚

æ¥ä¸‹æ¥åœ¨`.github/workflows`é‡Œæ–°å»º`cd.yml`æ¥å®šä¹‰**CD Workflow**ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: CD
on:
  # ä»¥ä¸»å¹²çš„pushäº‹ä»¶ä½œä¸ºè§¦å‘æ¡ä»¶
  push:
    branches: main
jobs:
  CD:
    runs-on: ubuntu-latest
    steps:
      # æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v2
      # ä¸‹è½½Node
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16.x"
      # æ·»åŠ ç¼“å­˜ï¼Œé€»è¾‘å’ŒCI Workflowé‡Œçš„ä¸€æ ·
      - name: Cache
        id: cache-dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
          key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
      # å®‰è£…ä¾èµ–ã€‚å‘½ä¸­ç¼“å­˜åˆ™è·³è¿‡æ­¤æ­¥
      - name: Installing Dependencies
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: yarn install
      # ä»package.jsoné‡Œè·å–versionå±æ€§çš„å€¼
      # åœ¨CD Workflowä¸­ä¼šç»™æ¯ä¸ªç”Ÿæˆçš„åˆ¶å“æ‰“ä¸Šæ ‡ç­¾ï¼Œè€Œæ ‡ç­¾å–å€¼äºversionå€¼
      - name: Read Version
        # è¯»å–å‡ºæ¥çš„å€¼ä¼šæ”¾åœ¨steps.[id].outputs.valueä¾›å…¶ä»–æ­¥éª¤stepè¯»å–
        id: version
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ./package.json
          property: version
      # æ‰“åŒ…ç”Ÿæˆåˆ¶å“ï¼Œä¸”æŠŠåˆ¶å“å‹ç¼©åˆ°assets.zipå‹ç¼©åŒ…é‡Œ
      - name: Building
        run: |
          yarn build
          zip -r assets ./dist/**
      # åŸºäºå½“å‰commitè¿›è¡Œç‰ˆæœ¬å‘å¸ƒ(Create a release)ï¼Œtag_nameæ˜¯vå‰ç¼€åŠ ä¸Špackage.jsonçš„versionå€¼
      - name: Create GitHub Release
        # æ­¤æ­¥éª¤ä¸­ï¼Œç‰ˆæœ¬å‘å¸ƒåä¼šè¿”å›å¯¹åº”çš„urlï¼Œä»¥ä¾›ä¸‹é¢ä¸Šä¼ åˆ¶å“çš„æ­¥éª¤ä¸­è¯»å–ä½¿ç”¨
        id: create_release
        uses: actions/create-release@v1
        env:
          # GITHUB_TOKENæ˜¯å‡†å¤‡å·¥ä½œæ­¥éª¤ä¸‰ç”³è¯·çš„Personal Access Token
          GITHUB_TOKEN: ${{ secrets.PROJECT_ACCESS_TOKEN }}
        with:
          tag_name: v${{steps.version.outputs.value}}
          release_name: v${{steps.version.outputs.value}}
          draft: false
          prerelease: false
      # æŠŠassets.zipä¸Šä¼ åˆ°ä»“åº“å¯¹åº”çš„å‘å¸ƒç‰ˆæœ¬Releaseä¸Š
      - name: Update Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_ACCESS_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./assets.zip
          asset_name: assets.zip
          asset_content_type: application/zip
      # æŠŠåˆ¶å“ä¸Šä¼ åˆ°éƒ¨ç½²æœºå™¨
      - name: Upload to Deploy Server
        uses: easingthemes/ssh-deploy@v2.0.7
        env:
          # SSH_PRIVATE_KEYä¸ºå‡†å¤‡å·¥ä½œæ­¥éª¤ä¸‰ä¸­ç”Ÿæˆå¯†é’¥å¯¹é‡Œçš„ç§é’¥
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_TOKEN }}
          # æŒ‡å®šå½“å‰ç›®å½•ä¸­è¦ä¸Šä¼ çš„å†…å®¹
          SOURCE: "dist/"
          # æŒ‡å®šä¸Šä¼ åˆ°éƒ¨ç½²æœºå™¨çš„å“ªä¸ªç›®å½•ä¸‹
          TARGET: "/data/www"
          # ä¸Šä¼ å‰æŒ‡ä»¤ï¼Œæ­¤å¤„ç”¨äºæ¸…ç©ºTARGETä¸‹çš„æ–‡ä»¶
          ARGS: "-avzr --delete"
          # REMOTE_HOSTä¸ºæœºå™¨çš„å…¬ç½‘IP
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          # REMOTE_USERä¸ºç™»å½•æœºå™¨æ—¶ç”¨åˆ°è´¦å·å
          REMOTE_USER: ${{secrets.REMOTE_USER}}
```

è¿™æ ·å­å°±å®Œæˆäº†**CD Workflow**çš„æµç¨‹äº†ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a9aa0c1c9e3b48fba193017b9de0898f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

åœ¨**CD Workflow**è¿è¡Œå®Œæˆåï¼Œå¯ä»¥è¾“å…¥è‡ªå·±æœºå™¨çš„å…¬ç½‘ IP æŸ¥çœ‹éƒ¨ç½²çš„é¡¹ç›®ã€‚**æ³¨æ„ï¼šæ¯æ¬¡æ pr æ—¶è¦ç¡®ä¿ package.json ä¸­çš„ version å€¼æœ‰å˜åŒ–ï¼Œä¸ç„¶ CD Workflow ä¼šåœ¨ Create GitHub Release çš„æ­¥éª¤é‡ŒæŠ¥å·²å­˜åœ¨ Tag çš„é”™è¯¯ã€‚**

**å…³äº CD Workflow ç»†èŠ‚è¡¥å……ï¼š**

1.  _ä¸ºä»€ä¹ˆè¦è·å–`package.json`ä¸­`version`å€¼ï¼Œæœ‰ä»€ä¹ˆä½œç”¨?_
    
    `version`å€¼åœ¨**CD Workflow**ä¸»è¦ç”¨äºç‰ˆæœ¬å‘å¸ƒï¼Œæ­¤è¿‡ç¨‹éœ€è¦å¡«å†™æŒ‡å®šçš„`tag_name`ã€‚å‘å¸ƒçš„ç‰ˆæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6b2f57ce89f64881be4635e41ce2a9f1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
    
    ç‚¹è¿›å»åå¯ä»¥çœ‹åˆ°å½“å‰é¡¹ç›®çš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62b357bd98724867946a81b3a45ab151~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
    
    æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨é€šè¿‡[VSCode GitGraph æ’ä»¶](https://marketplace.visualstudio.com/items?itemName=mhutchie.git-graph "https://marketplace.visualstudio.com/items?itemName=mhutchie.git-graph")æ¥çœ‹åˆ°è‡ªå·±å‘å¸ƒçš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆcommit å†™çš„æœ‰ç‚¹éšä¾¿ï¼Œä¸è¦ä»‹æ„ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97aa18a6e64045ed9d1246bf5798db92~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
    
    åœ¨æ¯æ¬¡**ä¸»å¹²**æ›´æ–°åè¿›è¡Œç‰ˆæœ¬å‘å¸ƒä¸ä»…ç¬¦åˆå¼€æºé¡¹ç›®çš„æ›´æ–°æµç¨‹ï¼Œè€Œä¸”åˆ©äºæˆ‘ä»¬ä¹‹åéƒ¨ç½²ç‰¹å®š**å‘å¸ƒç‰ˆæœ¬**çš„åˆ¶å“ï¼ˆå¯çœ‹ä¸‹é¢**æ·±å…¥ç« èŠ‚çš„å›æ»šæµç¨‹**ï¼‰ã€‚
    
2.  ä¸ºä»€ä¹ˆè¦æœ‰ **Update Release Asset** è¿™ä¸ªæ­¥éª¤ï¼Ÿ
    
    é¦–å…ˆï¼ŒæŠŠåˆ¶å“æ”¾åœ¨å¯¹åº”çš„**å‘å¸ƒç‰ˆæœ¬**ä¸Šæ˜¯å¾ˆå¸¸è§çš„å¼€æºè¡Œä¸ºï¼Œè¯»è€…ä¹Ÿå¯ä»¥æŠŠåˆ¶å“ä¸‹è½½ä¸‹æ¥æ”¾åˆ°`nginx`ç›´æ¥æŸ¥çœ‹é¡µé¢æ•ˆæœã€‚å…¶æ¬¡ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ï¼Œæ˜¯ä¸ºäº†**å›æ»šï¼ˆä¸‹é¢æ·±å…¥ç¯‡ä¼šå†™å›æ»šæœºåˆ¶çš„å®ç°ï¼‰**çš„å®ç°ï¼Œå›æ»šéœ€è¦å¿«é€Ÿè·å–å‰ä¸€ä¸ª**å‘å¸ƒç‰ˆæœ¬**çš„åˆ¶å“è¦†ç›–åˆ°éƒ¨ç½²æœºå™¨ä¸Šã€‚å› æ­¤éœ€è¦æˆ‘ä»¬æŠŠæ¯ä¸ªåˆ¶å“éƒ½å­˜æ”¾åœ¨å¯¹åº”çš„**å‘å¸ƒç‰ˆæœ¬**ä»¥å®ç°æŒä¹…åŒ–ã€‚
    
3.  _ä¸ºä»€ä¹ˆ **Update Release Asset(ä¸Šä¼ åˆ¶å“)** é˜¶æ®µä¸ä½¿ç”¨[`actions/upload-artifact`](https://github.com/actions/upload-artifact "https://github.com/actions/upload-artifact")ï¼š_
    
    é¦–å…ˆåœ¨**Release**ä¸­ä¸Šä¼ åˆ¶å“æ˜¯å¾ˆå¤šå¼€æºé¡¹ç›®ä¸­å¸¸è§çš„æ“ä½œï¼Œå…¶æ¬¡`actions/upload-artifact`ä¸­å­˜åœ¨ä¸¤ä¸ªç¼ºç‚¹ï¼š
    
    1.  ä¸Šä¼ çš„åˆ¶å“åªèƒ½ä¾›åŒä¸€ä¸ª`Workflow`çš„ä¸åŒ`Job`ä¸­ä½¿ç”¨ã€‚æ¢è¨€ä¹‹ï¼Œä¸åŒ`Workflow`æ˜¯ä¸èƒ½ä½¿ç”¨è¿™ä¸ªåˆ¶å“çš„ï¼Œè¿™æ ·å­æˆ‘ä»¬å°±ä¸åˆ©äºæˆ‘ä»¬åœ¨ä¸åŒçš„æµç¨‹å»è°ƒç”¨è¿™ä¸ªåˆ¶å“ã€‚ä¾‹å¦‚**å›æ»šï¼ˆä¸‹é¢æ·±å…¥ç¯‡ä¼šå†™å›æ»šæœºåˆ¶çš„å®ç°ï¼‰**ï¼Œåœ¨å½“å‰éƒ¨ç½²æœºå™¨ä¸Šçš„é¡¹ç›®å­˜åœ¨é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å›æ»šè¿…é€ŸæŠŠå‰ä¸€ä¸ªç¨³å®šçš„ç‰ˆæœ¬çš„åˆ¶å“è¦†ç›–åˆ°éƒ¨ç½²æœºå™¨ä¸Šã€‚
        
    2.  ä¸Šä¼ çš„åˆ¶å“æœ€å¤šåªå­˜åœ¨ 90 å¤©ï¼Œä¸èƒ½åšåˆ°æŒä¹…åŒ–ã€‚
        
    
    å› æ­¤è¿™é‡Œæ²¡é€‰æ‹©`actions/upload-artifact`ã€‚
    

## æ·»åŠ çŠ¶æ€å¾½ç« 

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c002a4f5f8946d7a77a2eac0721475f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

æˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®çš„`README.md`ä¸­åŠ äº†`CI`å’Œ`CD`ä¸¤ä¸ªçŠ¶æ€å¾½ç« æ¥ä»£è¡¨è¿™ä¸ªé¡¹ç›®å·²æˆåŠŸå®ç°äº†`CI`å’Œ`CD`çš„æµç¨‹ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚è¿™ä¸¤ä¸ªçŠ¶æ€å¾½ç« æ˜¯æ ¹æ®ä½ æŒ‡å®šçš„**Workflow**çš„åç§°å’Œæœ€è¿‘ä¸€æ¬¡è¿è¡Œçš„ç»“æœåŠ¨æ€å˜åŒ–çš„ã€‚å¦‚æœå¯¹åº”çš„æµæ°´çº¿å¹¶æ²¡æœ‰è¿è¡Œè®°å½•ï¼Œåˆ™æ•ˆæœå¦‚å›¾ä¸Šçš„`E2E-Test`çŠ¶æ€å¾½ç« æ‰€ç¤ºã€‚

å¾½ç« å¯ä»¥ç›´æ¥ä»¥ä¸‹é¢çš„æ ¼å¼æ¥æ’å…¥åˆ°è‡ªå·±çš„`README.md`ä¸Šï¼š

```md
![example workflow](https://github.com/<OWNER>/<REPOSITORY>/actions/workflows/<WORKFLOW_FILE>/badge.svg)
```

ä¾‹å¦‚æˆ‘çš„`CI`å’Œ`CD`å¾½ç« åˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºï¼š

```md
![CI](https://github.com/Hitotsubashi/cicd-study/actions/workflows/ci.yml/badge.svg)

![CD](https://github.com/Hitotsubashi/cicd-study/actions/workflows/cd.yml/badge.svg)
```

å…³äºæ›´å¤šæœ‰å…³å·¥ä½œæµç¨‹çŠ¶æ€å¾½ç« çš„å¯çœ‹å®˜æ–¹æ–‡æ¡£[æ·»åŠ å·¥ä½œæµç¨‹çŠ¶æ€å¾½ç« ](https://docs.github.com/cn/actions/monitoring-and-troubleshooting-workflows/adding-a-workflow-status-badge "https://docs.github.com/cn/actions/monitoring-and-troubleshooting-workflows/adding-a-workflow-status-badge")

# æ·±å…¥ç¯‡ï¼šå®Œå–„æµç¨‹

## è®¾ç½®é‚®ä»¶é€šçŸ¥

å¦‚æœæƒ³è¦æµæ°´çº¿åœ¨è¿è¡Œç»“æŸåæŠŠè¿è¡Œç»“æœå‘é€é€šçŸ¥åˆ°é‚®ä»¶ä¸Šï¼Œä¸å¿…åœ¨æµæ°´çº¿é‡Œä¿®æ”¹ï¼Œç›´æ¥ç‚¹å‡»è‡ªå·±çš„å¤´åƒï¼Œä¾æ¬¡è¿›å…¥ **Settings > Notifications** é¡µé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baf0a9218a6e46a18e553dd8d620263e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

æ­¤é¡µé¢æ»šåˆ°ä¸‹é¢æœ‰`Actions`é€šçŸ¥è®¾ç½®ï¼Œæ­¤å¤„å¦‚æœå‹¾é€‰ï¼Œåˆ™åªä¼šåœ¨ **Workflow** è¿è¡Œå¤±è´¥åå‘é€é€šçŸ¥åˆ°é‚®ç®±ï¼Œå–æ¶ˆå‹¾é€‰åˆ™åœ¨æ˜¯ **Workflow** åœ¨è¿è¡Œç»“æŸåæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šå‘é€é€šçŸ¥åˆ°é‚®ç®±ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d04dba7972de4d1eb774aab0c03caf22~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å‘é€çš„é‚®ç®±æ˜¯å½“å‰ç»‘å®šä½ ç™»å½•çš„`github`è´¦å·çš„é‚®ç®±ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±åœ¨ **Settings > Notifications**æ·»åŠ æ–°çš„é‚®ç®±å¦‚å›¾æ‰€ç¤ºï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8854460597774f80aa738d9c8945af87~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

## æ·»åŠ å›æ»šæœºåˆ¶

åœ¨é¡¹ç›®å‘å¸ƒåï¼Œå¦‚æœå‘ç°å½“å‰é¡¹ç›®å­˜åœ¨é‡å¤§**bug**æ—¶ï¼Œä¸€èˆ¬æ“ä½œå°±æ˜¯æ‰‹åŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚å› æ­¤éœ€è¦æ–°å¢ä¸€ä¸ªç”¨äº**å›æ»š**çš„**workflow**(ä¸‹ç§°**Rollback Workflow**)ã€‚

é¦–å…ˆè¿˜æ˜¯è¦ç¡®å®š**Rollback Workflow**çš„è§¦å‘æ¡ä»¶**Event**ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©[`workflow_dispatch`](https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch "https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch")ã€‚`workflow_dispatch`äº‹ä»¶è¿˜èƒ½æ”¯æŒæ‰‹åŠ¨è¾“å…¥ä¿¡æ¯ï¼Œç„¶åæŠŠè¿™ä¸ªä¿¡æ¯å½“ä½œç¯å¢ƒå˜é‡ä¾›æ•´ä¸ª**Workflow**è¯»å–ã€‚

ä¸ºäº†å…ˆäº†è§£`workflow_dispatch`äº‹ä»¶ç±»å‹çš„æ•ˆæœï¼Œä¸‹é¢æˆ‘æˆªå–**Rollback Workflow**çš„`on`éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
on:
  workflow_dispatch:
    # inputsä¸‹é¢å¯ä»¥æŒ‡å®šè¦æ‰‹åŠ¨è¾“å…¥çš„ä¿¡æ¯
    inputs:
      # ä¾‹å¦‚è¿™é‡Œæˆ‘æŒ‡å®šäº†æ‰‹åŠ¨è¾“å…¥versionä¿¡æ¯
      version:
        # è¿™æ˜¯å¯¹è¯¥ä¿¡æ¯çš„æè¿°
        description: "choose a version to deploy"
        # æŒ‡å®šå¿…é¡»å¡«å†™
        required: true
```

ç„¶ååœ¨`Github`å¯¹åº”çš„**Rollback Workflow**é¡µé¢ä¸­ï¼Œç‚¹å‡»**Run workflow**æŒ‰é’®åå¡«å†™`version`åç‚¹å‡»**Run workflow**å°±å¯ä»¥è§¦å‘è¯¥æµæ°´çº¿çš„æ‰§è¡Œï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a4fb27e8b5742129f43670142c6fd2e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ä¸‹é¢æ¥çœ‹çœ‹æ•´ä¸ª**Rollback Workflow**çš„ä»£ç ï¼š

```yml
name: Rollback
on:
  workflow_dispatch:
    inputs:
      # è¿™é‡Œçš„versionæŒ‡çš„æ˜¯æˆ‘ä»¬è¦éƒ¨ç½²çš„å“ªä¸ªå‘å¸ƒç‰ˆæœ¬çš„åˆ¶å“
      # è¿™é‡Œè¾“å…¥çš„ä¿¡æ¯ä¼šä½œä¸ºgithub.event.inputs.versionä¾›æ­¤Workflowä¸‹çš„jobè¯»å–
      version:
        description: "choose a version to deploy"
        required: true
jobs:
  Rollback:
    runs-on: ubuntu-latest
    steps:
      # è¾“å‡ºæˆ‘ä»¬è¾“å…¥çš„versionå€¼
      - name: Echo Version
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "Version: $VERSION"
      # è·å–å¯¹åº”å‘å¸ƒç‰ˆæœ¬çš„åˆ¶å“
      - name: Download Artifact
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: "tags/${{ github.event.inputs.version }}"
          # æŒ‡å®šå­˜æ”¾åˆ¶å“çš„å‹ç¼©åŒ…
          file: "assets.zip"
          # è¿™é‡Œéœ€è¦CD Workflowä¸­å‡†å¤‡å·¥ä½œé‡Œçš„Github Personal Access Token
          token: ${{ secrets.GITHUB_TOKEN }}
      # ä¸‹è½½å‹ç¼©åŒ…åè§£å‹
      - name: Unzip
        run: |
          unzip assets.zip
          ls -a ./dist
      # æŠŠåˆ¶å“æ”¾åˆ°éƒ¨ç½²æœºå™¨ä¸Š
      - name: Upload to Deploy Server
        uses: easingthemes/ssh-deploy@v2.0.7
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_TOKEN }}
          ARGS: "-avzr --delete"
          SOURCE: "dist/"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{secrets.REMOTE_USER}}
          TARGET: "/data/www"
```

åœ¨è§¦å‘**Rollback Workflow**åè¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33e619c777ef46319934353298bd12ea~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ç”±äºè¿™é‡Œçš„é¡¹ç›®æ¯”è¾ƒå°ï¼Œå› æ­¤æ•´ä¸ª**å›æ»š**è¿‡ç¨‹åªéœ€è¦ 7 ç§’ã€‚

## æ·»åŠ ç«¯å¯¹ç«¯æµ‹è¯•

### æ¦‚å¿µ

**ç«¯å¯¹ç«¯æµ‹è¯•(E2E Test)**æŒ‡å¯¹éƒ¨ç½²åœ¨æµ‹è¯•ç¯å¢ƒæˆ–æ­£å¼ç¯å¢ƒçš„é¡¹ç›®è¿›è¡Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ“ä½œçš„æµ‹è¯•ã€‚ä¸€èˆ¬ä¼šç”¨å¦‚`puppeteer`è¿™ç±»èƒ½é€šè¿‡**Devtools åè®®**æ§åˆ¶æµè§ˆå™¨çš„æµ‹è¯•æ¡†æ¶æ¥å®ç°ã€‚

æˆ‘ä»¬åœ¨å†™å‰ç«¯æµ‹è¯•çš„ç†æƒ³å æ¯”åº”å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03354a783dd645b1aae3397fc2db4aae~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å› ä¸º**ç«¯å¯¹ç«¯æµ‹è¯•**æœ¬è´¨æ³¨å®šå…¶éœ€è¦æŠ•å…¥çš„å·¥ä½œé‡æ¯”è¾ƒå¤šï¼Œå› æ­¤ï¼Œä¸»è¦ç”¨äºè¦†ç›–åº”ç”¨çš„æ ¸å¿ƒç‰¹æ€§ã€‚å¯¹äºå…¶ä½™æ¬¡è¦ç‰¹æ€§æˆ‘ä»¬å¯ä»¥ç”¨**é›†æˆæµ‹è¯•**å’Œ**å•å…ƒæµ‹è¯•**å»è¦†ç›–ã€‚

### ä»£ç å®ç°

ä¸‹é¢æˆ‘å°±é€šè¿‡`puppeteer`å’Œ`jest`ç»“åˆå»ç®€å•å†™ä¸€ä¸ªé’ˆå¯¹`App.tsx`çš„ç«¯å¯¹ç«¯æµ‹è¯•ï¼Œé¦–å…ˆæ–°å»ºä¸€ä¸ªç”¨äº**ç«¯å¯¹ç«¯æµ‹è¯•**çš„`jest`é…ç½®æ–‡ä»¶**jest.config.e2e.js**ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

**jest.config.e2e.js**

```js
module.exports = {
  preset: "jest-puppeteer",
  setupFilesAfterEnv: ["expect-puppeteer"],
  testTimeout: 100000,
  testMatch: ["<rootDir>/src/e2e/**/*.{spec,test}.{js,jsx,ts,tsx}"],
  globals: {
    "ts-jest": {
      tsConfig: "<rootDir>/tsconfig.json",
    },
  },
};
```

ç„¶åå¼€å§‹ç¼–å†™é’ˆå¯¹`App.tsx`çš„ç«¯å¯¹ç«¯æµ‹è¯•ä»£ç ï¼š

**src/e2e/App.test.tsx**

```tsx
const DEFAULT_URL = "http://localhost:3000/";

describe("Check Page", () => {
  // beforeAllå‡½æ•°ä¼šåœ¨æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹è¿è¡Œå‰å…ˆè¿è¡Œ
  beforeAll(async () => {
    // æ­¤å¤„ä¼šè®¾è®¡äº†ä¸€ä¸ªæ ¹æ®å‘½ä»¤è¡Œå‚æ•°æ¥æŒ‡å®šæµ‹è¯•ç½‘å€çš„é€»è¾‘
    // å¯é€šè¿‡npm run test:e2e -- --URL=*** æˆ– yarn test:e2e --URL=*** æ¥æŒ‡å®šæµ‹è¯•ç½‘å€
    // å¦åˆ™é»˜è®¤æµ‹è¯•ç½‘å€ä¸º DEFAULT_URL
    let dynamicUrl = "";
    process.argv.forEach((item) => {
      const matches = item.match(/^\-\-URL\=(.*)$/);
      if (matches) {
        dynamicUrl = matches[1];
      }
    });
    await page.goto(dynamicUrl || DEFAULT_URL);
  });

  // æµ‹è¯•ç‚¹å‡»æŒ‰é’®æ˜¯å¦æœ‰æ•ˆï¼Œä¸€èˆ¬ç«¯å¯¹ç«¯æµ‹è¯•æ˜¯ç”¨å¿«ç…§æ¥å¯¹æ¯”åˆ¤æ–­æ˜¯å¦æˆåŠŸçš„ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ç›´æ¥è·å–DOMå…ƒç´ çš„contentå€¼æ¥åˆ¤æ–­
  it("click button", async () => {
    await page.click('[role="button"]');
    const content = await page.$eval('[role="button"]', (el) => el.textContent);
    await expect(content).toEqual("count is: 1");
  });
});
```

åœ¨`package.json`çš„`scripts`æ·»åŠ å‘½ä»¤è¡Œï¼š`"test:e2e": "jest --config=jest.config.e2e.js"`åè¿è¡Œï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6439a9a1bad94b97bc8ee38cfc532472~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å…³äº`puppeteer`çš„æ›´å¤šç”¨æ³•è¯·çœ‹[å®˜æ–¹æ–‡æ¡£](https://pptr.dev/ "https://pptr.dev/")ã€‚

**æ³¨æ„ï¼šè¿è¡Œå‰è¯·ç¡®ä¿æµ‹è¯•ç½‘å€ä¸Šçš„åº”ç”¨å¯æ­£å¸¸è®¿é—®**

### æ·»åŠ æµæ°´çº¿

#### å®ç°ç«¯å¯¹ç«¯æµ‹è¯•æµæ°´çº¿

**ç«¯å¯¹ç«¯æµ‹è¯•**æ˜¯ä¸€é¡¹æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œå› ä¸ºæ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½éœ€è¦å¼€å¯ä¸€ä¸ª**æ— å¤´æµè§ˆå™¨ï¼ˆnon-headlessï¼‰**æ¥æ‰§è¡Œã€‚æ‰€ä»¥ä¸€èˆ¬ä¼šç”¨ä¸€ä¸ªå•ç‹¬çš„ **Job** æˆ–è€…å•ç‹¬çš„ **Workflow** æ¥æ‰§è¡Œ(è¿™æ ·å¯ä»¥å¼€å¯ä¸€ä¸ªå•ç‹¬çš„**Runner**ï¼Œå³è¿›ç¨‹æ¥æ‰§è¡Œ)ã€‚

é¦–å…ˆè¦ç¡®å®š**ç«¯å¯¹ç«¯æµ‹è¯•**çš„_è¿è¡Œæ—¶æœº_ï¼š

1.  åœ¨**CD éƒ¨ç½²**æˆ–è€…**å›æ»š**åéƒ½å¯èƒ½è°ƒç”¨**ç«¯å¯¹ç«¯æµ‹è¯•**æ¥æµ‹è¯•åˆšéƒ¨ç½²çš„é¡¹ç›®çš„ç¨³å®šæ€§
2.  æœ‰æ—¶å€™ä¹Ÿè¦æ‰‹åŠ¨è§¦å‘**ç«¯å¯¹ç«¯æµ‹è¯•**çš„è¿è¡Œï¼Œè€Œç”±äº**ç«¯å¯¹ç«¯æµ‹è¯•**æ˜¯å¯¹éƒ¨ç½²åœ¨æµ‹è¯•ç¯å¢ƒæˆ–ç”Ÿäº§ç¯å¢ƒçš„é¡¹ç›®ä¸Šè¿›è¡Œæµ‹è¯•çš„ï¼Œå› æ­¤å‰ç«¯ã€åç«¯ã€æ•°æ®åº“åŒæ ·ä¼šå½±å“**ç«¯å¯¹ç«¯æµ‹è¯•**çš„è¿è¡Œç»“æœï¼Œå› æ­¤åœ¨**åç«¯è¿­ä»£å‘å¸ƒ**æˆ–è€…**æ•°æ®åº“å˜æ›´**åï¼Œä¹Ÿè¦æ‰‹åŠ¨è§¦å‘è¿è¡Œ**ç«¯å¯¹ç«¯æµ‹è¯•**ä»¥ä¿è¯é¡¹ç›®çš„ç¨³å®šæ€§ã€‚

é’ˆå¯¹æ­¤ï¼Œæˆ‘ä»¬æŠŠ**ç«¯å¯¹ç«¯æµ‹è¯•**è®¾è®¡ä¸ºå•ç‹¬çš„æµæ°´çº¿**E2E Test Workflow**ï¼Œå…¶è§¦å‘æ¡ä»¶**Event**è®¾è®¡ä¸ºä¸¤ä¸ªï¼š

-   `workflow_call`ï¼š[`workflow_call`](https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_call "https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_call")å¯ä»¥ä½¿**E2E Test Workflow**æˆä¸ºå¯è¢«è°ƒç”¨çš„æµæ°´çº¿ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨**CD Workflow**å’Œ**Rollback Workflow**é‡Œè°ƒç”¨ç”¨åˆ°ã€‚å¯¹åº”ä¸Šé¢_è¿è¡Œæ—¶æœºçš„ç¬¬ 1 ç‚¹_ã€‚
    
-   `workflow_dispatch`ï¼š[`workflow_dispatch`](https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch "https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch")å¯ä»¥è®©æˆ‘ä»¬éšæ—¶æ‰‹åŠ¨è§¦å‘**E2E Test Workflow**è¿è¡Œï¼Œå¯¹åº”_è¿è¡Œæ—¶æœºçš„ç¬¬ 2 ç‚¹_ã€‚
    

æ¥ä¸‹æ–°å»º`e2e-test.yml`æ¥ç¼–å†™**E2E Test Workflow**ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: E2E-Test
# onè®¾è®¡ä¸ºæ•°ç»„çš„æ¨¡å¼ï¼ŒæŒ‡å®šworkflow_call å’Œ workflow_dispatchä¸¤ç§è§¦å‘æœºåˆ¶
on: [workflow_call, workflow_dispatch]
jobs:
  E2E-Test:
    runs-on: ubuntu-latest
    steps:
      # æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v2
      # ä¸‹è½½Node
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16.x"
      # æ·»åŠ ç¼“å­˜
      - name: Cache
        id: cache-dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
          key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
      # å®‰è£…ä¾èµ–
      - name: Installing Dependencies
        # åœ¨ if æ¡ä»¶ä¸‹ä½¿ç”¨è¡¨è¾¾å¼æ—¶ï¼Œå¯ä»¥çœç•¥è¡¨è¾¾å¼è¯­æ³• (${{ }})ï¼Œå› ä¸º GitHub ä¼šè‡ªåŠ¨å°† if æ¡ä»¶ä½œä¸ºè¡¨è¾¾å¼æ±‚å€¼ã€‚
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: yarn install
      # è¿è¡Œç«¯å¯¹ç«¯æµ‹è¯•ï¼ŒæŒ‡å®šæµ‹è¯•ç½‘å€ä¸ºéƒ¨ç½²æœºå™¨çš„å…¬ç½‘IP
      - name: Running E2E Test
        run: yarn test:e2e --URL=http://${{ secrets.REMOTE_HOST }}/
```

æ‰‹åŠ¨è¿è¡Œèµ·æ¥æ•ˆæœå’Œ`Rollback Workflow`çš„å·®ä¸å¤šï¼Œè¿™é‡Œå°±ä¸å†é‡å¤å±•ç¤ºäº†ã€‚

#### åœ¨`CD`ä¸­è°ƒç”¨ç«¯å¯¹ç«¯æµ‹è¯•

æˆ‘ä»¬è¦åœ¨**CD Workflow**é‡Œè°ƒç”¨**E2E Test Workflow**ï¼Œå› æ­¤éœ€è¦åœ¨**CD Workflow**å¯¹åº”çš„é…ç½®æ–‡ä»¶`cd.yml`é‡Œæ·»åŠ ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: CD
on: #...ä»£ç æ²¡å˜ï¼Œçœç•¥
jobs:
  CD: # ...ä»£ç æ²¡å˜ï¼Œçœç•¥
  # æ·»åŠ åä¸ºE2E-Testçš„Job
  E2E-Test:
    # æŒ‡æ˜è¦è°ƒç”¨çš„æµæ°´çº¿æ‰€åœ¨çš„è·¯å¾„
    uses: ./.github/workflows/e2e-test.yml
    # æŒ‡å®šè¯¥Jobåœ¨Job CD æ‰§è¡Œå®Œåæ‰§è¡Œï¼Œä¸ç„¶Jobä¼šå¹¶è¡Œæ‰§è¡Œ
    needs: [CD]
    # æŒ‡å®šè°ƒç”¨çš„æµæ°´çº¿é›†æˆå½“å‰æµæ°´çº¿çš„secret
    secrets: inherit
```

åœ¨è§¦å‘**CD Workflow**åè¿è¡Œå¦‚ä¸‹æ•ˆæœæ‰€ç¤ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e099366efc148b6ae4723a1586dd19c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

åŒæ ·çš„ä¹Ÿå¯ä»¥ç‚¹è¿›å»çœ‹æ¯ä¸ªæ­¥éª¤çš„æ§åˆ¶å°è¾“å‡ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9656e63dfce4e07a8fff8c43954b1e4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

#### åœ¨å›æ»šä¸­é€‰æ‹©æ€§è°ƒç”¨ç«¯å¯¹ç«¯æµ‹è¯•

**å›æ»š**åå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ˜¯å¦è¿›è¡Œ**ç«¯å¯¹ç«¯æµ‹è¯•**ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åŸæœ‰çš„æ‰‹åŠ¨è¾“å…¥åŸºç¡€ä¸ŠåŠ ä¸€ä¸ªå‹¾é€‰æ¡†å†³å®šæ˜¯å¦è¿è¡Œ**ç«¯å¯¹ç«¯æµ‹è¯•**å³å¯ï¼Œå…¶ä½™çš„é€»è¾‘ä¸**CD Workflow**çš„**E2E-Test Job**ç±»ä¼¼ã€‚æˆ‘ä»¬å¯¹**Rollback Workflow**å¯¹åº”çš„é…ç½®æ–‡ä»¶`rollback.yml`å¦‚ä¸‹æ‰€ç¤ºï¼š

```yml
name: Rollback
on:
  workflow_dispatch:
    inputs:
      version: # ...ä»£ç æ²¡å˜ï¼Œçœç•¥
      # æ–°å¢å‹¾é€‰æ¡†å†³å®šæ˜¯å¦æ‰§è¡Œç«¯å¯¹ç«¯æµ‹è¯•
      E2ETest:
        description: "enable torun e2e test"
        # ç±»å‹ä¸ºbooleanæ—¶ï¼Œæ§ä»¶ä¼šä»¥å‹¾é€‰æ¡†çš„å½¢å¼å‘ˆç°
        type: boolean
        # é»˜è®¤å€¼è®¾ä¸ºtrueï¼Œä»£è¡¨é»˜è®¤å‹¾é€‰
        default: true
jobs:
  Rollback: # ...ä»£ç æ²¡å˜ï¼Œçœç•¥
  E2E-Test:
    uses: ./.github/workflows/e2e-test.yml
    needs: [Rollback]
    # æ¡ä»¶åˆ¤æ–­ E2ETestå‹¾é€‰æ¡† æ˜¯å¦è¢«å‹¾é€‰ï¼Œå‹¾é€‰åˆ™æ‰§è¡Œï¼Œæ²¡å‹¾é€‰åˆ™è·³è¿‡
    if: github.event.inputs.E2ETest == true
    # æŒ‡å®šè°ƒç”¨çš„æµæ°´çº¿é›†æˆå½“å‰æµæ°´çº¿çš„secret
    secrets: inherit
```

æ‰‹åŠ¨æ‰§è¡Œæ—¶æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e2308a4a1d04c1d8666255ad94a5529~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å¦‚æœæŠŠ`E2E-Test`å‹¾é€‰æ¡†å–æ¶ˆå‹¾é€‰åè¿è¡Œï¼Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17b8a7e934fd470795b2713776947f2f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

## æ€è€ƒï¼šå®Œæ•´çš„ CD ç©æ³•ï¼ˆå¾…è¡¥å……ï¼‰ï¼Ÿ

å‰é¢çš„**CD ç« èŠ‚**ä¸­ï¼Œè€ƒè™‘åˆ°å…¥é—¨ä»¥åŠå¤§å¤šæ•°è¯»è€…åªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œå› æ­¤åœ¨è®¾è®¡æ­¥éª¤ä¸­è·³è¿‡äº†æµ‹è¯•ç¯å¢ƒçš„éƒ¨ç½²ä¸æµ‹è¯•ï¼Œä½¿å…¶æœ‰ç‚¹ç‘•ç–µã€‚åœ¨ä¹‹åæˆ‘ä¼šç»§ç»­æ›´æ–°è¿™ç¯‡æ–‡ç« æ¥è¡¥å……è¿™éƒ¨åˆ†çš„ç« èŠ‚ã€‚

# åè®°

è¿™ç¯‡æ–‡ç« å†™åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¦‚æœè§‰å¾—æœ‰ç”¨å¯ä»¥ç‚¹èµæ”¶è—ï¼Œå¦‚æœæœ‰ç–‘é—®å¯ä»¥ç›´æ¥åœ¨è¯„è®ºç•™è¨€ï¼Œæ¬¢è¿äº¤æµ ğŸ‘ğŸ‘ğŸ‘ ã€‚